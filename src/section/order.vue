<template>
  <div
    id="order"
    class="order relative text-center"
  >
    <div class="order-section">
      <div class="order-title text-center font-['Noto_Serif_TC',serif]">
        <svg
          class="ml-auto mr-auto"
          width="441"
          height="69"
          viewBox="0 0 441 69"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M61.9718 51.0802C60.2978 60.5663 52.3075 68.831 36.5859 68.831H0L0.0345224 68.6242H1.36336C5.55694 68.6242 8.07653 68.1936 8.80135 64.1134L19.2939 4.71763C20.0015 0.68905 17.6372 0.206796 13.4436 0.206796H12.1148L12.1493 0H43.9031C58.5548 0 64.4913 6.45734 62.7311 16.3739C61.3505 24.2244 56.5702 29.3023 44.093 33.4858C51.2203 32.2634 64.267 37.7205 61.9545 51.0802H61.9718ZM55.0515 51.1324C57.226 38.84 48.0622 32.6933 40.3308 34.6559C40.1755 34.6559 40.0547 34.7085 39.8821 34.7602L39.5888 34.8627C21.8825 40.062 18.9833 45.3477 18.362 48.9114L14.8932 68.5721H36.6205C46.3882 68.5721 53.3085 60.6697 55.0515 51.1492V51.1324ZM27.008 0.413592L18.8452 46.5711C21.848 40.3733 31.8919 36.7747 39.5542 34.5366C50.1849 31.4549 54.3267 25.1533 55.8799 16.4075C57.6229 6.50818 53.6536 0.413592 43.8859 0.413592H26.9908H27.008Z"
            fill="#8FB538"
          />
          <path
            d="M143.772 43.7608C141.322 57.6371 131.192 68.9311 116.54 68.9311C111.277 68.9311 107.066 67.5029 104.011 64.9549C100.059 67.4512 95.3478 68.9311 90.0843 68.9311C75.4326 68.9311 69.289 57.6543 71.7568 43.7608C74.2074 29.8846 84.3375 18.5923 98.9892 18.5923C104.253 18.5923 108.464 20.0205 111.518 22.5685C115.47 20.0721 120.181 18.5923 125.445 18.5923C140.045 18.5923 146.24 29.8846 143.772 43.7608ZM101.94 62.8886C98.1263 58.2747 96.8492 51.3876 98.2126 43.7608C99.5759 36.0824 103.217 29.2487 108.705 24.6348C106.565 21.0882 103.234 18.9706 98.9201 18.9706C89.1524 18.9706 80.5754 29.8846 78.1248 43.7608C75.6742 57.6371 80.3856 68.5528 90.1533 68.5528C94.4504 68.5528 98.5577 66.4351 101.94 62.8886ZM104.581 43.7608C103.562 49.5455 103.804 54.7793 105.081 58.9628C107.842 54.7793 109.93 49.5283 110.949 43.7608C111.967 37.9934 111.725 32.7424 110.448 28.5588C107.635 32.7424 105.599 37.9934 104.581 43.7608ZM137.404 43.7608C139.855 29.8846 135.144 18.9706 125.376 18.9706C121.079 18.9706 116.989 21.0882 113.589 24.6348C117.403 29.2487 118.68 36.1341 117.334 43.7608C115.971 51.4393 112.329 58.2747 106.841 62.8886C108.981 66.4351 112.312 68.5528 116.626 68.5528C126.394 68.5528 134.971 57.6371 137.422 43.7608H137.404Z"
            fill="#8FB538"
          />
          <path
            d="M198.6 68.7082L198.565 68.915H174.767L174.801 68.7082H177.252C181.446 68.7082 182.55 66.3843 181.377 64.3184L181.497 64.5252L166.501 37.8737L162.876 40.6798L158.735 64.1469C158.027 68.1755 160.391 68.6561 164.568 68.6561H165.897L165.862 68.8628H143.548L143.583 68.6561H144.911C149.105 68.6561 151.625 68.2271 152.349 64.1469L162.255 8.09011C162.842 4.80182 162.152 3.58035 156.388 6.4038L156.422 6.197L170.038 0.050293L162.946 40.1636L175.319 30.5754C176.441 29.6801 177.718 28.7148 179.133 27.613C185.156 22.9474 190.161 18.6602 195.476 18.6602C200.791 18.6602 201.464 23.2229 199.635 26.3907C198.565 24.583 196.097 22.9996 192.801 22.9996C189.505 22.9996 185.398 23.7401 180.773 27.08C179.565 27.9236 177.597 29.4044 175.716 30.73L172.023 33.5882L188.866 63.5786C190.799 67.0219 192.68 68.725 196.511 68.725H198.582L198.6 68.7082ZM191.869 68.9318L191.783 68.7771L188.866 63.6291L191.869 68.9318Z"
            fill="#8FB538"
          />
          <path
            d="M298.693 0.050293H306.666L306.632 0.257089H305.303C301.109 0.257089 298.59 0.687695 297.865 4.76793L286.527 68.9318H286.164L249.889 3.39097L239.155 64.1637C238.447 68.1923 240.794 68.6745 245.005 68.6745H246.334L246.299 68.8813H229.991L230.025 68.6745H231.354C235.548 68.6745 238.067 68.2439 238.792 64.1637L249.285 4.76793C249.992 0.739343 247.645 0.257089 243.452 0.257089H242.123L242.157 0.050293H256.602L288.235 57.2251L297.502 4.76793C298.21 0.739343 295.863 0.257089 291.652 0.257089H290.323L290.358 0.050293H298.693Z"
            fill="#8FB538"
          />
          <path
            d="M348.706 43.7608C346.255 57.6371 336.125 68.9311 321.473 68.9311C306.822 68.9311 300.678 57.6543 303.146 43.7608C305.596 29.8846 315.726 18.5923 330.378 18.5923C345.03 18.5923 351.173 29.8846 348.706 43.7608ZM342.32 43.7608C344.771 29.8846 340.06 18.9706 330.292 18.9706C320.524 18.9706 311.947 29.8846 309.496 43.7608C307.046 57.6371 311.757 68.5528 321.525 68.5528C331.293 68.5528 339.87 57.6371 342.32 43.7608Z"
            fill="#8FB538"
          />
          <path
            d="M440.826 18.5923L440.792 18.747H439.894C435.701 18.747 432.957 19.228 430.437 23.3082L402.307 68.9311L393.316 34.4987L372.089 69L360.182 23.3772C359.094 19.2969 356.523 18.8159 352.33 18.8159H351.432L351.467 18.6091H374.35L374.298 18.9185H372.538C368.345 18.9185 365.98 19.3491 367.067 23.4293L376.801 60.634L393.178 34.0868L390.4 23.3772C389.364 19.2969 386.793 18.8159 382.599 18.8159H381.702L381.736 18.6091H404.62L404.568 18.8663H402.808C398.614 18.8663 396.25 19.2969 397.337 23.3772L407.07 60.5819L430.144 23.1704C432.422 19.2967 430.282 18.8327 426.192 18.8327H424.449L424.483 18.6259H440.843L440.826 18.5923Z"
            fill="#8FB538"
          />
        </svg>
      </div>
      <!-- <div
        class="order-subTitle text-center"
        v-if="info.order.subTitle"
        v-html="
          $isMobile() && info.order.subTitle_mo
            ? info.order.subTitle_mo
            : info.order.subTitle
        "
      ></div> -->

      <!-- Form -->
      <div class="form mx-auto relative flex justify-center">
        <div
          class="left h-full flex flex-col justify-between items-center font-['Noto_Serif_TC',serif]"
        >
          <label class="row name"
            ><span>姓名<span>(必填)</span></span>
            <input
              type="text"
              placeholder="姓名"
              class="input w-full rounded-none"
              :value="formData.name"
              @input="(event) => (formData.name = event.target.value)"
          /></label>

          <label class="row"
            ><span>手機<span>(必填)</span></span>
            <input
              type="text"
              placeholder="手機"
              class="input w-full rounded-none"
              :value="formData.phone"
              @input="(event) => (formData.phone = event.target.value)"
          /></label>

          <!-- 動態 select 欄位產生 預算 用途 等 在index.js控制  -->
          <template
            v-for="(fieldData, fieldKey) in selectFields"
            :key="fieldKey"
          >
            <label class="row">
              <span
                >{{ fieldData.title
                }}<span v-if="fieldData.bypass">*</span></span
              >
              <select
                class="select w-full rounded-none bg-white"
                v-model="formData[fieldKey]"
              >
                <option
                  value=""
                  disabled
                >
                  {{ fieldData.hold }}
                </option>
                <option
                  v-for="option in fieldData.option"
                  :value="option"
                  :key="option"
                >
                  {{ option }}
                </option>
              </select>
            </label>
          </template>
          <!-- 動態 select end-->

          <!--  -->
          <label class="row"
            ><span>居住縣市</span>
            <select
              class="select w-full rounded-none"
              v-model="formData.city"
            >
              <option
                value=""
                selected
                disabled
              >
                請選擇城市
              </option>
              <option
                v-for="city in cityList"
                :value="city.value"
                :key="city"
              >
                {{ city.label }}
              </option>
            </select></label
          >
          <label class="row"
            ><span>居住地區</span>
            <select
              class="select w-full rounded-none"
              v-model="formData.area"
            >
              <option
                value=""
                selected
                disabled
              >
                請選擇地區
              </option>
              <option
                v-for="area in areaList"
                :value="area.value"
                :key="area"
              >
                {{ area.label }}
              </option>
            </select></label
          >
        </div>
        <div class="right">
          <textarea
            :value="formData.msg"
            @input="(event) => (formData.msg = event.target.value)"
            class="row textarea w-full h-full rounded-none"
            placeholder="(非必填) 請輸入您的留言"
          ></textarea>
        </div>
      </div>

      <!-- Policy -->
      <div class="flex gap-2 items-center justify-center control">
        <input
          type="checkbox"
          v-model="formData.policyChecked"
          :checked="formData.policyChecked"
          class="checkbox bg-white rounded-md"
        />
        <p class="text-[#000]">
          本人知悉並同意<label
            for="policy-modal"
            class="modal-button text-[#c00] cursor-pointer hover:opacity-70"
            >「個資告知事項聲明」</label
          >內容
        </p>
      </div>
      <Policy />

      <!-- Recaptcha -->
      <vue-recaptcha
        class="flex justify-center mt-8 z-10"
        ref="recaptcha"
        :sitekey="info.recaptcha_site_key_v2"
        @verify="onRecaptchaVerify"
        @expired="onRecaptchaUnVerify"
      />

      <!-- Send -->
      <div
        class="send mt-8 mx-auto hover:scale-90 btn cursor-pointer"
        @click="send()"
      >
        {{ sending ? '發送中..' : '立即預約' }}
      </div>

      <!-- Contact Info -->
      <ContactInfo />
    </div>

    <!-- Map -->
    <Map v-if="info.googleSrc" />

    <!-- HouseInfo -->
    <HouseInfo />
  </div>
</template>

<style lang="scss">
@import '@/assets/style/function.scss';

.order-section {
  position: relative;
  // padding-top: size(406);
  overflow: hidden;
  min-height: size(500);

  .bg-image {
    position: absolute;
    width: 100%;
    left: 0;
    bottom: size(50);
    vertical-align: middle;
  }
}

.order {
  width: 100%;
  padding-top: size(40);
  /*
  background:url("@/section/form/bg.jpg");
  background-size: auto;
  */
  //background: linear-gradient(to bottom, #00a6e9, #009e41);
  background: #fff;

  .order-title {
    font-size: size(40);
    font-weight: 600;
    color: #fff;
    padding-top: 1.5em;

    //filter: drop-shadow(5px 5px 5px rgba(0, 0, 0, 0.8))
    .line {
      width: size(439);
    }
  }

  .order-title-img {
    width: size(1138);
    margin-top: size(155);
    margin-bottom: size(85);
  }

  .order-subTitle {
    font-size: size(17);
    color: #fff;
    padding-top: 0.8em;
    letter-spacing: 0.1em;
    //font-weight: 500;filter: drop-shadow(5px 5px 5px rgba(0, 0, 0, 0.8))
  }

  .cus-divider {
    margin: 0 auto;
    width: size(300);
    height: size(2);
    margin-bottom: size(50);
    //  background-color: #055F76;
  }

  .form {
    width: size(920);
    min-width: 750px;
    //  height: 350px;
    gap: size(80);
    margin-top: size(45);
    margin-bottom: size(50);
    z-index: 50;
    align-items: stretch;

    .left {
      position: relative;
      flex: 1;
      gap: size(20);
      align-items: flex-start;
      //   width: size(419);
    }

    .right {
      flex: 1;
      height: auto;
      //  width: size(419);
    }

    &::after {
      content: '';
      width: size(1);
      height: 100%;
      background-color: #0003;
      position: absolute;
    }

    .row {
      background: #fff;
      border-bottom: 1px solid #999;
      color: #000;
      display: flex;
      width: 100%;
      align-items: center;
      resize: none;

      > span {
        width: 5.5em;
        text-align: left;
        padding-left: 1em;

        > span {
          color: #c00;
          font-size: sizem(8);
          @media screen and (min-width: 768px) {
            font-size: size(10);
          }
        }
      }

      input,
      select {
        background: inherit;
        flex: 1;
      }

      option {
        color: #666;
      }

      select {
        background: url('//h35.banner.tw/img//select.svg') no-repeat
          calc(100% - 0.5em) 100%;
        background-size: auto 200%;
        transition: background 0.3s;

        &:focus {
          background-position: calc(100% - 0.5em) 0%;
        }
      }

      &.name {
        //width: calc(100% - 3.8em);
      }

      //沒有性別的話這條槓掉
    }

    .gender {
      display: flex;
      position: absolute;
      right: 0;
      flex-direction: column;
      color: #fff;

      label:first-child {
        margin-bottom: 0.3em;
      }

      input {
        margin-right: 0.3em;
      }
    }
  }

  .send {
    font-size: 20px;
    letter-spacing: 0.9em;
    text-indent: 0.9em;
    color: #fff;
    background-color: #8FB538;
    border: 1px solid #8FB538;
    width: 410px;
    height: 72px;
    line-height: 3.3;
    z-index: 10;
    font-weight: 400;
    position: relative;
  }

  .control {
    font-size: size(16);
    color: #000;
    position: relative;
  }
}

@media screen and (max-width: 768px) {
  .order-section {
    min-height: sizem(800);
    position: relative;
    // overflow: hidden;
    // padding-top: sizem(200);

    .bg-image {
      position: absolute;
      width: 100%;
      left: -#{sizem(30)};
      bottom: sizem(590);
    }
  }

  .order {
    width: 100%;
    padding-bottom: sizem(63);

    .cus-divider {
      margin: 0 auto;
      width: sizem(117);
      height: sizem(2);
      margin-bottom: sizem(25);
      background-color: #055f76;
    }

    .order-title {
      font-size: sizem(27);
      padding-top: 2em;
      .line {
        width: sizem(258);
      }
    }
    .order-subTitle {
      font-size: sizem(13);
      padding-top: 0;
    }

    .order-title-img {
      width: sizem(259);
      margin-bottom: sizem(25);
    }

    .form {
      width: sizem(310);
      min-width: 0;
      height: auto;
      gap: sizem(15);
      margin-bottom: sizem(20);
      flex-direction: column;
      margin-top: sizem(20);

      .left {
        width: 100%;
        gap: sizem(15);
      }

      .right {
        width: 100%;
        height: sizem(100);

        .row {
          height: 7em;
        }
      }

      &::after {
        display: none;
      }
    }

    .send {
      font-size: sizem(21);
      width: sizem(310);
      height: sizem(72);
    }

    .control {
      font-size: sizem(14.6);
    }
  }
}
</style>

<script setup>
import Policy from '@/section/form/policy.vue';
import ContactInfo from '@/section/form/contactInfo.vue';
import Map from '@/section/form/map.vue';
import HouseInfo from '@/section/form/houseInfo.vue';

import info from '@/info';

import { cityList, renderAreaList } from '@/info/address.js';
import {
  computed,
  getCurrentInstance,
  ref,
  reactive,
  watch,
  onMounted
} from 'vue';
import { VueRecaptcha } from 'vue-recaptcha';

const globals = getCurrentInstance().appContext.config.globalProperties;
const isMobile = computed(() => globals.$isMobile());

// const selectFields = info.selectFields

import { useToast } from 'vue-toastification';
const toast = useToast();

const sending = ref(false);

// 後端那 name phone email msg 為必要欄位 請勿刪除
const requiredFields = {
  // 固定必要欄位 (請勿刪)
  name: '姓名',
  phone: '手機',
  email: '信箱',
  msg: '備註訊息',
  city: '居住縣市',
  area: '居住地區',
  gender: '性別',
  policyChecked: '個資告知事項聲明',
  r_verify: '機器人驗證'
};

// selectFields
const selectFields = info.selectFields || {};

// 初始 formData（包含 selectFields 欄位）
const formData = reactive({
  ...Object.keys(requiredFields).reduce((acc, key) => {
    acc[key] = key === 'policyChecked' || key === 'r_verify' ? false : '';
    return acc;
  }, {}),
  ...Object.keys(selectFields).reduce((acc, key) => {
    acc[key] = '';
    return acc;
  }, {})
});

// bypass（非必填欄位，根據 selectFields 的 bypass 設定）
const staticBypass = ['email', 'msg', 'city', 'area', 'gender'];
const bypass = [
  ...staticBypass,
  ...Object.entries(selectFields)
    .filter(([_, field]) => field.bypass !== true)
    .map(([key]) => key)
];

// 中文對照（formDataRef）
const formDataRef = {
  ...requiredFields,
  ...Object.entries(selectFields).reduce((acc, [key, val]) => {
    acc[key] = val.title || key;
    return acc;
  }, {})
};

const areaList = ref([]);

watch(
  () => formData.city,
  (newVal, oldVal) => {
    areaList.value = renderAreaList(newVal);
    formData.area = areaList.value[0].value;
  }
);
// 新系統這裡需調整
const onRecaptchaVerify = (token) => {
  formData.r_verify = token;
};
const onRecaptchaUnVerify = () => {
  formData.r_verify = false;
};

const send = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const utmSource = urlParams.get('utm_source') || 'null'; // 确保有有效的来源
  const utmMedium = urlParams.get('utm_medium') || 'null';
  const utmContent = urlParams.get('utm_content') || 'null';
  const utmCampaign = urlParams.get('utm_campaign') || 'null';
  const time = new Date();
  const year = time.getFullYear();
  const month = time.getMonth() + 1;
  const day = time.getDate();
  const hour = time.getHours();
  const min = time.getMinutes();
  const sec = time.getSeconds();
  const date = `${year}-${month}-${day} ${hour}:${min}:${sec}`;

  const presend = new FormData();
  let pass = true;
  let unfill = [];
  let idx = 0;

  if (formData.gender) {
    formData.name = `${formData.name}(${formData.gender})`;
  }
  // 验证必填字段
  for (const [key, value] of Object.entries(formData)) {
    if (!bypass.includes(key) && (value === '' || value === false)) {
      unfill.push(formDataRef[key] || key);
      pass = false;
    }
    if (key !== 'r_verify' && key !== 'policyChecked') {
      presend.append(key, value);
    }
  }
  presend.append('utm_source', utmSource);
  presend.append('utm_medium', utmMedium);
  presend.append('utm_content', utmContent);
  presend.append('utm_campaign', utmCampaign);
  presend.append('message', formData.msg);
  presend.append('case_code', info.case_code ? info.case_code : info.caseid);

  // 如果有必填字段为空，返回
  if (!pass) {
    toast.error(`「${unfill.join(', ')}」為必填或必選`);
    return;
  }

  // 手机格式验证
  const MobileReg = /^(09)[0-9]{8}$/;
  if (!formData.phone.match(MobileReg)) {
    toast.error('手機格式錯誤 ( 09開頭10位數字 )');
    return;
  }

  // 如果通过验证
  if (pass && !sending.value) {
    sending.value = true;
    fetch(
      `https://script.google.com/macros/s/AKfycbyQKCOhxPqCrLXWdxsAaAH06Zwz_p6mZ5swK80USQ/exec?name=${formData.name}
      &phone=${formData.phone}
      &email=${formData.email}
      &cityarea=${formData.city}${formData.area}
      &msg=${formData.room_type}；${formData.msg}
      &utm_source=${utmSource}
      &utm_medium=${utmMedium}
      &utm_content=${utmContent}
      &utm_campaign=${utmCampaign}
      &date=${date}
      &campaign_name=${info.caseName}`,
      {
        method: 'GET'
      }
    );
    //caseid 在index.js裡設定
    fetch('https://service-sys.lixin.com.tw/reserve/' + info.caseid, {
      method: 'POST',
      body: presend
    })
      .then((response) => {
        if (response.status === 200) {
          window.location.href = 'formThanks';
        } else {
          return response.json().then((err) => {
            console.error('後端錯誤訊息：', err);
            toast.error(err.message || '提交失敗');
          });
        }
      })
      .catch((error) => {
        console.error('傳送失敗：', error);
        toast.error('無法連線或伺服器錯誤');
      })
      .finally(() => {
        sending.value = false;
      });
  }
};
</script>
